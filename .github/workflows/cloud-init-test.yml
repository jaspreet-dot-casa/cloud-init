name: Cloud-Init Tests

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'cloud-init/**'
      - 'tests/**'
      - '.github/workflows/cloud-init-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'cloud-init/**'
      - 'tests/**'
  workflow_dispatch:

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: make lint

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check scripts/lib/ syntax
        run: |
          for f in scripts/lib/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check scripts/packages/ syntax
        run: |
          for f in scripts/packages/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check scripts/shared/ syntax
        run: |
          for f in scripts/shared/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check scripts/cloud-init/ syntax
        run: |
          for f in scripts/cloud-init/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check cloud-init/ syntax
        run: |
          for f in cloud-init/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.8"

      - name: Terraform fmt
        run: terraform fmt -check
        working-directory: terraform

      - name: Terraform init
        run: terraform init -backend=false
        working-directory: terraform

      - name: Terraform validate
        run: terraform validate
        working-directory: terraform

  cloud-init-generate:
    name: Test Cloud-Init Generation
    runs-on: ubuntu-latest
    needs: [syntax-check]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gettext-base

      - name: Create test secrets
        run: |
          cat > cloud-init/secrets.env << 'EOF'
          USERNAME="testuser"
          HOSTNAME="test-server"
          SSH_PUBLIC_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAITestKey test@example.com"
          USER_NAME="Test User"
          USER_EMAIL="test@example.com"
          TAILSCALE_AUTH_KEY=""
          GITHUB_PAT=""
          REPO_URL="https://github.com/jaspreet-dot-casa/cloud-init.git"
          REPO_BRANCH="main"
          EOF

      - name: Generate cloud-init.yaml
        run: |
          chmod +x cloud-init/generate.sh
          ./cloud-init/generate.sh

      - name: Validate generated YAML
        run: |
          # Check file exists
          test -f cloud-init/cloud-init.yaml

          # Check for required sections
          grep -q "users:" cloud-init/cloud-init.yaml
          grep -q "hostname:" cloud-init/cloud-init.yaml
          grep -q "packages:" cloud-init/cloud-init.yaml
          grep -q "runcmd:" cloud-init/cloud-init.yaml

          # Check username substitution
          grep -q "name: testuser" cloud-init/cloud-init.yaml

          # Ensure no unsubstituted variables
          ! grep -q '\${USERNAME}' cloud-init/cloud-init.yaml
          ! grep -q '\${HOSTNAME}' cloud-init/cloud-init.yaml

          echo "YAML validation passed"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [syntax-check]
    steps:
      - uses: actions/checkout@v4

      - name: Run test suite
        env:
          HOME: /tmp
        run: |
          chmod +x tests/test-runner.sh
          ./tests/test-runner.sh

  docker-integration:
    name: Docker Integration Test
    runs-on: ubuntu-latest
    needs: [lint, syntax-check]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build test container
        run: |
          docker build -t cloud-init-test -f tests/Dockerfile.test .

      - name: Run integration tests
        run: |
          docker run --rm -e HOME=/tmp cloud-init-test bash tests/test-packages.sh
