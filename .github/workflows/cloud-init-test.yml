name: Cloud-Init Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          wget -qO- "https://github.com/koalaman/shellcheck/releases/download/v0.11.0/shellcheck-v0.11.0.linux.x86_64.tar.xz" | tar -xJf -
          sudo mv shellcheck-v0.11.0/shellcheck /usr/local/bin/
          shellcheck --version

      - name: Run shellcheck
        run: make lint

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check scripts/lib/ syntax
        run: |
          for f in scripts/lib/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check scripts/packages/ syntax
        run: |
          for f in scripts/packages/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check scripts/shared/ syntax
        run: |
          for f in scripts/shared/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check scripts/cloud-init/ syntax
        run: |
          for f in scripts/cloud-init/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

      - name: Check cloud-init/ syntax
        run: |
          for f in cloud-init/*.sh; do
            echo "Checking $f..."
            bash -n "$f"
          done

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.8"

      - name: Terraform fmt
        run: terraform fmt -check
        working-directory: terragrunt

      - name: Terraform init
        run: terraform init -backend=false
        working-directory: terragrunt

      - name: Terraform validate
        run: terraform validate
        working-directory: terragrunt

  cloud-init-template:
    name: Validate Cloud-Init Template
    runs-on: ubuntu-latest
    needs: [syntax-check]
    steps:
      - uses: actions/checkout@v4

      - name: Validate template structure
        run: |
          template="cloud-init/cloud-init.template.yaml"

          # Check file exists
          test -f "$template"
          echo "✓ Template file exists"

          # Check for required sections
          grep -q "^users:" "$template"
          echo "✓ Has users: section"

          grep -q "^hostname:" "$template"
          echo "✓ Has hostname: section"

          grep -q "^packages:" "$template"
          echo "✓ Has packages: section"

          grep -q "^runcmd:" "$template"
          echo "✓ Has runcmd: section"

          grep -q "^write_files:" "$template"
          echo "✓ Has write_files: section"

          # Check for template variables
          grep -q '\${USERNAME}' "$template"
          echo "✓ Uses \${USERNAME} variable"

          grep -q '\${HOSTNAME}' "$template"
          echo "✓ Uses \${HOSTNAME} variable"

          grep -q '\${DISABLED_PACKAGE_EXPORTS}' "$template"
          echo "✓ Uses \${DISABLED_PACKAGE_EXPORTS} variable"

          echo ""
          echo "Template validation passed"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [syntax-check]
    steps:
      - uses: actions/checkout@v4

      - name: Run test suite
        env:
          HOME: /tmp
        run: |
          chmod +x tests/test-runner.sh
          ./tests/test-runner.sh

  docker-integration:
    name: Docker Integration Test
    runs-on: ubuntu-latest
    needs: [lint, syntax-check]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build test container
        run: |
          docker build -t cloud-init-test -f tests/Dockerfile.test .

      - name: Run integration tests
        run: |
          docker run --rm -e HOME=/tmp cloud-init-test bash tests/test-packages.sh
